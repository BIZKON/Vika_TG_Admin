# TG-Hub V2: Архитектура системы

## Обзор

Единый хаб для модератора курсов, собирающий сообщения из 4 источников:
1. **Telegram Premium** (Business API) — личные сообщения рабочего аккаунта
2. **Telegram Группа #1** — группа учеников
3. **Telegram Группа #2** — группа кураторов
4. **GetCourse** (Webhook) — домашние задания и комментарии

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              ИСТОЧНИКИ                                   │
├──────────────────┬────────────────────┬────────────────┬────────────────┤
│  TG Business     │   TG Группа #1     │  TG Группа #2  │   GetCourse    │
│  (Premium)       │   (ученики)        │  (кураторы)    │   (Webhook)    │
│                  │                    │                │                │
│  Личные чаты →   │  Вопросы/          │  Обсуждения →  │  ДЗ/Оценки →   │
│  business_msg    │  сообщения →       │  сообщения →   │  HTTP POST     │
└────────┬─────────┴─────────┬──────────┴───────┬────────┴───────┬────────┘
         │                   │                  │                │
         └───────────────────┴────────┬─────────┴────────────────┘
                                      │
                              ┌───────▼───────┐
                              │   AGGREGATOR  │
                              │  (aiogram 3)  │
                              │               │
                              │  + FastAPI    │
                              │  (webhooks)   │
                              └───────┬───────┘
                                      │
                              ┌───────▼───────┐
                              │   HUB GROUP   │
                              │   (Telegram)  │
                              │               │
                              │  Все сообще-  │
                              │  ния сюда     │
                              └───────┬───────┘
                                      │
                              ┌───────▼───────┐
                              │  RAG System   │
                              │               │
                              │  LanceDB +    │
                              │  OpenAI Emb + │
                              │  Claude AI    │
                              └───────────────┘
```

## Источники данных

### 1. Telegram Business API (Premium)
- **Требование**: Telegram Premium на рабочем аккаунте
- **Подключение**: Настройки → Telegram Business → Чат-боты
- **Что получаем**: Копии всех личных сообщений
- **События**: `business_message`, `edited_business_message`

### 2. Telegram Группы (2 шт.)
- **Подключение**: Бот добавлен в группы с правами чтения
- **Что получаем**: Все сообщения в группах
- **События**: Стандартные update от Bot API

### 3. GetCourse Webhook
- **Подключение**: Процесс с операцией "Вызвать URL"
- **URL**: `https://your-server.com/webhook/getcourse`
- **Что получаем**: Данные о домашних заданиях, комментариях
- **Триггеры в GetCourse**:
  - Новое домашнее задание
  - Комментарий к уроку
  - Сообщение от ученика

## Технологии

| Компонент | Технология | Причина выбора |
|-----------|------------|----------------|
| Telegram Bot | **aiogram 3** | Поддержка Business API, асинхронность |
| Web Server | **FastAPI** | Webhooks от GetCourse, быстрый |
| База данных | **SQLite** | Простота, надёжность |
| Vector Store | **LanceDB** | Локальный, быстрый поиск |
| Embeddings | **OpenAI text-embedding-3-small** | Качество/цена |
| AI | **Claude (Anthropic)** | Генерация ответов |

## Файловая структура (V2)

```
Vika_TG_Admin/
├── main.py                 # Точка входа
├── config.py               # Конфигурация
├── requirements.txt        # Зависимости
├── .env                    # Секреты (не в git)
│
├── bot/
│   ├── __init__.py
│   ├── handlers/
│   │   ├── __init__.py
│   │   ├── business.py     # Business API (Premium)
│   │   ├── groups.py       # Сообщения из групп
│   │   ├── commands.py     # /help, /search, /draft
│   │   └── callbacks.py    # Inline-кнопки
│   └── keyboards.py        # Клавиатуры
│
├── webhooks/
│   ├── __init__.py
│   ├── server.py           # FastAPI сервер
│   └── getcourse.py        # Обработчик GetCourse
│
├── core/
│   ├── __init__.py
│   ├── aggregator.py       # Сборщик сообщений
│   ├── formatter.py        # Форматирование для хаба
│   ├── storage.py          # SQLite операции
│   └── filters.py          # Фильтрация сообщений
│
├── ai/
│   ├── __init__.py
│   ├── assistant.py        # Claude AI
│   ├── knowledge_base.py   # База знаний
│   ├── vector_store.py     # LanceDB
│   └── document_loader.py  # Загрузка документов
│
└── data/
    ├── messages.db         # SQLite база
    ├── vector_db/          # LanceDB данные
    ├── documents/          # Загруженные документы
    └── tg-hub.log          # Логи
```

## Конфигурация (.env)

```bash
# ═══════════════════════════════════════════
# TELEGRAM BOT
# ═══════════════════════════════════════════
BOT_TOKEN=7123456789:AAHxxxxxxxxxx

# Хаб-группа (куда стекаются все сообщения)
HUB_CHAT_ID=-100xxxxxxxxxx

# ID модератора (Виктории)
MODERATOR_USER_ID=123456789

# ═══════════════════════════════════════════
# МОНИТОРИНГ ГРУПП
# ═══════════════════════════════════════════
# Группа учеников
GROUP_STUDENTS_ID=-100xxxxxxxxxx
GROUP_STUDENTS_NAME=Ученики курса

# Группа кураторов
GROUP_CURATORS_ID=-100xxxxxxxxxx
GROUP_CURATORS_NAME=Кураторы

# ═══════════════════════════════════════════
# GETCOURSE ИНТЕГРАЦИЯ
# ═══════════════════════════════════════════
GETCOURSE_ENABLED=true
GETCOURSE_ACCOUNT_NAME=your_account
GETCOURSE_SECRET_KEY=your_api_key
GETCOURSE_WEBHOOK_SECRET=random_secret_string

# ═══════════════════════════════════════════
# WEB SERVER (для webhooks)
# ═══════════════════════════════════════════
WEBHOOK_HOST=0.0.0.0
WEBHOOK_PORT=8080
WEBHOOK_URL=https://your-domain.com

# ═══════════════════════════════════════════
# AI НАСТРОЙКИ
# ═══════════════════════════════════════════
AI_ENABLED=true
ANTHROPIC_API_KEY=sk-ant-xxx
OPENAI_API_KEY=sk-xxx

# ═══════════════════════════════════════════
# ДОПОЛНИТЕЛЬНО
# ═══════════════════════════════════════════
LOG_LEVEL=INFO
DB_PATH=data/messages.db
```

## Формат сообщений в хабе

### Из Telegram Business (личка)
```
┌─ 💬 ЛИЧНОЕ СООБЩЕНИЕ ─────────────────┐
│ От: Иван Петров (@ivanpetrov)         │
│ Аккаунт: 📱 Premium Business          │
├───────────────────────────────────────┤
│ Здравствуйте! У меня вопрос по       │
│ третьему уроку...                     │
├───────────────────────────────────────┤
│ 🕐 14:32 │ 🔴 Требует ответа          │
└───────────────────────────────────────┘
```

### Из группы
```
┌─ 👥 ГРУППА: Ученики курса ────────────┐
│ От: Мария Сидорова (@maria_s)         │
├───────────────────────────────────────┤
│ Кто-нибудь может объяснить           │
│ как работает задание 5?               │
├───────────────────────────────────────┤
│ 🕐 15:45 │ 🟡 Вопрос                   │
└───────────────────────────────────────┘
```

### Из GetCourse
```
┌─ 📚 GETCOURSE: Домашнее задание ──────┐
│ Ученик: Алексей Козлов                │
│ Email: kozlov@mail.ru                 │
│ Курс: Основы маркетинга               │
│ Урок: 5. Таргетированная реклама      │
├───────────────────────────────────────┤
│ Прикрепил файл: homework_5.pdf        │
│ Комментарий: "Прошу проверить"        │
├───────────────────────────────────────┤
│ 🕐 16:20 │ 📝 Требует проверки        │
│ [Открыть в GetCourse]                 │
└───────────────────────────────────────┘
```

## GetCourse: Настройка Webhook

### Шаг 1: Создать процесс в GetCourse
1. CRM → Процессы → Создать процесс
2. Тип объекта: **Пользователь** или **Задание**
3. Добавить блок "Операция" → "Вызвать URL"

### Шаг 2: Настроить вызов URL
```
URL: https://your-server.com/webhook/getcourse
Метод: POST
Секретный ключ: {webhook_secret}

Параметры (POST body):
- user_email: {object.email}
- user_name: {object.name}
- user_phone: {object.phone}
- lesson_title: {object.lesson_title}
- task_text: {object.task_text}
- course_title: {object.course_title}
```

### Шаг 3: Триггеры
Настроить автоматический запуск процесса при:
- Добавлении комментария к уроку
- Отправке домашнего задания
- Создании нового заказа (опционально)

## API Endpoints (FastAPI)

| Method | Endpoint | Описание |
|--------|----------|----------|
| POST | `/webhook/getcourse` | Принимает данные от GetCourse |
| GET | `/health` | Проверка статуса сервера |
| GET | `/stats` | Статистика (для админки) |

## Процесс обработки сообщения

```
1. ПОЛУЧЕНИЕ
   ├─ Telegram: aiogram handlers
   └─ GetCourse: FastAPI webhook

2. НОРМАЛИЗАЦИЯ
   └─ Приведение к единому формату IncomingMessage

3. ФИЛЬТРАЦИЯ
   ├─ Проверка на дубликаты
   ├─ Проверка mute-списка
   └─ Анализ приоритета

4. СОХРАНЕНИЕ
   └─ SQLite: messages, message_mapping

5. ОТПРАВКА В ХАБ
   └─ Форматированное сообщение + inline-кнопки

6. AI ОБРАБОТКА (опционально)
   ├─ RAG: поиск релевантного контекста
   ├─ Claude: генерация черновика
   └─ Отправка черновика как reply
```

## Запуск

```bash
# Установка
pip install -r requirements.txt

# Запуск
python main.py

# Или через systemd (продакшн)
sudo systemctl start tg-hub
```

## Команды бота

| Команда | Описание |
|---------|----------|
| `/help` | Список команд |
| `/status` | Статус системы |
| `/search <запрос>` | Поиск в базе знаний |
| `/draft` | Сгенерировать черновик (reply) |
| `/mute <chat_id>` | Замьютить чат |
| `/unmute <chat_id>` | Размьютить чат |
| `/stats` | Статистика сообщений |
| `/gc_status` | Статус GetCourse интеграции |

## Требования

- Python 3.11+
- Telegram Premium (для Business API)
- GetCourse (платный тариф с API)
- VPS с публичным IP и доменом (для webhooks)
- SSL сертификат (Let's Encrypt)
