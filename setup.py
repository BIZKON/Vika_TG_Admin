#!/usr/bin/env python3
"""
TG-Sync: –ü–æ–º–æ—â–Ω–∏–∫ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ü–ï–†–ï–î –æ—Å–Ω–æ–≤–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º.

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
1. –°–æ–∑–¥–∞—ë—Ç .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
2. –ü–æ–º–æ–≥–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã (—Å–æ–∑–¥–∞—ë—Ç session-—Ñ–∞–π–ª—ã)
3. –ü–æ–º–æ–≥–∞–µ—Ç —É–∑–Ω–∞—Ç—å ID —Ö–∞–±-–≥—Ä—É–ø–ø—ã –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞

–ó–∞–ø—É—Å–∫: python setup.py
"""

import asyncio
import os
import shutil
from pathlib import Path


def print_header():
    print()
    print("=" * 50)
    print("  TG-Sync: –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞")
    print("=" * 50)
    print()


def print_step(n, title):
    print(f"\n{'‚îÄ' * 40}")
    print(f"  –®–∞–≥ {n}: {title}")
    print(f"{'‚îÄ' * 40}\n")


def setup_env():
    """–°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª."""
    if os.path.exists(".env"):
        resp = input("‚ö†Ô∏è  .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å? (y/n): ")
        if resp.lower() != "y":
            print("–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ .env")
            return

    print_step(1, "Telegram API Credentials")
    print("–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://my.telegram.org ‚Üí API Development")
    print("–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ api_id –∏ api_hash\n")

    work_api_id = input("–ê–∫–∫–∞—É–Ω—Ç 1 (—Ä–∞–±–æ—á–∏–π) ‚Äî api_id: ").strip()
    work_api_hash = input("–ê–∫–∫–∞—É–Ω—Ç 1 (—Ä–∞–±–æ—á–∏–π) ‚Äî api_hash: ").strip()
    work_phone = input("–ê–∫–∫–∞—É–Ω—Ç 1 (—Ä–∞–±–æ—á–∏–π) ‚Äî –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (+7...): ").strip()

    print()
    personal_api_id = input("–ê–∫–∫–∞—É–Ω—Ç 2 (–ª–∏—á–Ω—ã–π) ‚Äî api_id: ").strip()
    personal_api_hash = input("–ê–∫–∫–∞—É–Ω—Ç 2 (–ª–∏—á–Ω—ã–π) ‚Äî api_hash: ").strip()
    personal_phone = input("–ê–∫–∫–∞—É–Ω—Ç 2 (–ª–∏—á–Ω—ã–π) ‚Äî –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (+7...): ").strip()

    print_step(2, "–ë–æ—Ç")
    print("–°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather –≤ Telegram")
    print("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞\n")

    bot_token = input("Bot Token: ").strip()

    print_step(3, "–•–∞–±-–≥—Ä—É–ø–ø–∞")
    print("1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—É—é –≥—Ä—É–ø–ø—É –≤ Telegram")
    print("2. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∞")
    print("3. –î–æ–±–∞–≤—å—Ç–µ –í–∏–∫—Ç–æ—Ä–∏—é –≤ –≥—Ä—É–ø–ø—É")
    print("4. ID –≥—Ä—É–ø–ø—ã —É–∑–Ω–∞–µ–º –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ\n")

    hub_chat_id = input("Hub Chat ID (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º ‚Äî —É–∑–Ω–∞–µ–º –ø–æ–∑–∂–µ): ").strip() or "0"

    print_step(4, "ID –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞")
    print("–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –±–æ—Ç—É @userinfobot –≤ Telegram")
    print("–û–Ω –ø–æ–∫–∞–∂–µ—Ç –≤–∞—à User ID\n")

    moderator_id = input("User ID –í–∏–∫—Ç–æ—Ä–∏–∏: ").strip()

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º .env
    env_content = f"""# ============================================
# TG-Sync Configuration
# Generated by setup.py
# ============================================

# –ê–∫–∫–∞—É–Ω—Ç 1 ‚Äî –†–∞–±–æ—á–∏–π
ACCOUNT_WORK_API_ID={work_api_id}
ACCOUNT_WORK_API_HASH={work_api_hash}
ACCOUNT_WORK_PHONE={work_phone}

# –ê–∫–∫–∞—É–Ω—Ç 2 ‚Äî –õ–∏—á–Ω—ã–π
ACCOUNT_PERSONAL_API_ID={personal_api_id}
ACCOUNT_PERSONAL_API_HASH={personal_api_hash}
ACCOUNT_PERSONAL_PHONE={personal_phone}

# –ë–æ—Ç
BOT_TOKEN={bot_token}
HUB_CHAT_ID={hub_chat_id}
MODERATOR_USER_ID={moderator_id}

# AI (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
ANTHROPIC_API_KEY=
AI_ENABLED=false

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
LOG_LEVEL=INFO
DB_PATH=data/messages.db
REPLY_DELAY_SECONDS=1
AUTO_REPLY_ENABLED=false
AUTO_REPLY_TIMEOUT_MINUTES=30
AUTO_REPLY_TEXT=–í–∏–∫—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç–∏—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–∂–∏–¥–∞–Ω–∏–µ!
"""

    with open(".env", "w") as f:
        f.write(env_content)

    print("\n‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω!")


async def authorize_accounts():
    """–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã (—Å–æ–∑–¥–∞—Ç—å session-—Ñ–∞–π–ª—ã)."""
    print_step(5, "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤")

    try:
        from telethon import TelegramClient
        from dotenv import load_dotenv
        load_dotenv()
    except ImportError:
        print("‚ö†Ô∏è  –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: pip install -r requirements.txt")
        return

    Path("data/sessions").mkdir(parents=True, exist_ok=True)

    accounts = [
        ("work", os.getenv("ACCOUNT_WORK_API_ID"), os.getenv("ACCOUNT_WORK_API_HASH"), os.getenv("ACCOUNT_WORK_PHONE")),
        ("personal", os.getenv("ACCOUNT_PERSONAL_API_ID"), os.getenv("ACCOUNT_PERSONAL_API_HASH"), os.getenv("ACCOUNT_PERSONAL_PHONE")),
    ]

    for name, api_id, api_hash, phone in accounts:
        if not api_id or not api_hash or api_id == "0":
            print(f"‚è≠  –ü—Ä–æ–ø—É—Å–∫ –∞–∫–∫–∞—É–Ω—Ç–∞ '{name}': –Ω–µ—Ç credentials")
            continue

        print(f"\nüì± –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞: {name} ({phone})")
        print("Telegram –æ—Ç–ø—Ä–∞–≤–∏—Ç –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...\n")

        client = TelegramClient(
            f"data/sessions/{name}",
            int(api_id),
            api_hash,
        )

        await client.start(phone=phone)
        me = await client.get_me()
        print(f"‚úÖ {name}: –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ {me.first_name} (ID: {me.id})")
        await client.disconnect()

    # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
    bot_token = os.getenv("BOT_TOKEN")
    if bot_token:
        print(f"\nü§ñ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞...")
        # –î–ª—è –±–æ—Ç–∞ –Ω—É–∂–µ–Ω api_id/hash –ª—é–±–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
        api_id = os.getenv("ACCOUNT_WORK_API_ID", "0")
        api_hash = os.getenv("ACCOUNT_WORK_API_HASH", "")
        if api_id != "0":
            bot = TelegramClient("data/sessions/bot", int(api_id), api_hash)
            await bot.start(bot_token=bot_token)
            bot_me = await bot.get_me()
            print(f"‚úÖ –ë–æ—Ç: @{bot_me.username} (ID: {bot_me.id})")
            await bot.disconnect()


async def find_hub_chat_id():
    """–ü–æ–º–æ—á—å –Ω–∞–π—Ç–∏ ID —Ö–∞–±-–≥—Ä—É–ø–ø—ã."""
    print_step(6, "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ID —Ö–∞–±-–≥—Ä—É–ø–ø—ã")

    try:
        from telethon import TelegramClient
        from dotenv import load_dotenv
        load_dotenv()
    except ImportError:
        return

    api_id = os.getenv("ACCOUNT_WORK_API_ID", "0")
    api_hash = os.getenv("ACCOUNT_WORK_API_HASH", "")
    phone = os.getenv("ACCOUNT_WORK_PHONE", "")

    if api_id == "0":
        print("‚ö†Ô∏è  –ù–µ—Ç credentials –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥—Ä—É–ø–ø")
        return

    client = TelegramClient("data/sessions/work", int(api_id), api_hash)
    await client.start(phone=phone)

    print("–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∏:\n")
    async for dialog in client.iter_dialogs(limit=20):
        type_label = "üë§" if dialog.is_user else "üë•" if dialog.is_group else "üì¢"
        print(f"  {type_label} {dialog.name:40s} ‚îÇ ID: {dialog.id}")

    print("\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –Ω—É–∂–Ω–æ–π —Ö–∞–±-–≥—Ä—É–ø–ø—ã –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ .env ‚Üí HUB_CHAT_ID")
    await client.disconnect()


def main():
    print_header()

    print("–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å TG-Sync.\n")
    print("–ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å:")
    print("  1. –°–æ–∑–¥–∞—Ç—å .env —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏")
    print("  2. –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å Telegram-–∞–∫–∫–∞—É–Ω—Ç—ã")
    print("  3. –ù–∞–π—Ç–∏ ID —Ö–∞–±-–≥—Ä—É–ø–ø—ã")
    print()

    # –®–∞–≥ 1: .env
    setup_env()

    # –®–∞–≥ 2‚Äì3: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    resp = input("\n–ü–µ—Ä–µ–π—Ç–∏ –∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤? (y/n): ")
    if resp.lower() == "y":
        asyncio.run(authorize_accounts())

    # –®–∞–≥ 4: Hub ID
    resp = input("\n–ù–∞–π—Ç–∏ ID —Ö–∞–±-–≥—Ä—É–ø–ø—ã? (y/n): ")
    if resp.lower() == "y":
        asyncio.run(find_hub_chat_id())

    print("\n" + "=" * 50)
    print("  ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    print("=" * 50)
    print()
    print("–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
    print("  1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ HUB_CHAT_ID –∑–∞–ø–æ–ª–Ω–µ–Ω")
    print("  2. –ó–∞–ø—É—Å–∫: python main.py")
    print("  3. –ò–ª–∏ —á–µ—Ä–µ–∑ Docker: docker-compose up -d")
    print()


if __name__ == "__main__":
    main()
